name: CI

on:
  push:
    branches: [main, 'feature/*']
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Test
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install xcbeautify
        run: brew install xcbeautify

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Run tests
        run: |
          set -o pipefail
          swift test --enable-code-coverage 2>&1 | xcbeautify --report junit --junit-report-filename test-results.xml

      - name: Generate coverage report
        if: always()
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          XCTEST_PATH=$(find "$BIN_PATH" -name '*.xctest' -type d | head -1)
          if [ -n "$XCTEST_PATH" ]; then
            EXEC_PATH="$XCTEST_PATH/Contents/MacOS/$(basename "$XCTEST_PATH" .xctest)"
            xcrun llvm-cov export \
              "$EXEC_PATH" \
              -instr-profile="$(swift test --show-codecov-path 2>/dev/null | sed 's/\.json$/\.profdata/' || echo '.build/debug/codecov/default.profdata')" \
              -format=lcov > coverage.lcov 2>/dev/null || true
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

      - name: Publish test report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: test-results.xml
          reporter: java-junit

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results.xml ]; then
            TESTS=$(grep -c 'testcase' test-results.xml || echo "0")
            FAILURES=$(grep -c 'failure' test-results.xml || echo "0")
            echo "- Tests: $TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- Failures: $FAILURES" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build (Release)
    needs: test
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build release
        run: swift build -c release
